<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宮城県離島スタンプラリー</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="appContainer" style="display: none; height: 100%; display: flex; flex-direction: column;">
        <header class="header">
            <img src="./assets/title.png" alt="みやぎ離島スタンプラリー" class="app-title-image">
            <div class="points-display">
                <span class="points-label">ポイント:</span>
                <span class="points-value" id="pointsValue">0</span>
            </div>
        </header>

        <main class="main-content">
            <section id="mapSection" class="section active">
                <div class="section-header">
                    <h2>マップ</h2>
                    <p>島をタップして詳細を確認しましょう</p>
                </div>
                <div id="map" class="map-container"></div>
            </section>
            <section id="stampSection" class="section">
                <div class="section-header">
                    <h2>スタンプカード</h2>
                    <p>獲得したスタンプを確認できます</p>
                    </div>
                <div class="stamp-grid" id="stampGrid"></div>
            </section>
            <section id="entrySection" class="section">
                <div class="section-header">
                    <h2>応募</h2>
                    <p>ポイントを使って賞品に応募しましょう</p>
                </div>
                <div class="prizes-container" id="prizesContainer"></div>
                 <div class="history-container" id="historyContainer">
                     <div class="section-header">
                         <h3>応募履歴</h3>
                     </div>
                     <ul class="history-list" id="historyList">
                         
                     </ul>
                 </div>
                 <div class="entry-section-bottom-spacer"></div> </section>
        </main>

        <div id="qrModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>QRコード読み取り</h3>
                    <button id="closeQrModal" class="btn btn--secondary">閉じる</button>
                </div>
                <div id="qrReader" class="qr-reader"></div>
                <div class="qr-status" id="qrStatus"></div>
            </div>
        </div>
        <button id="qrCameraBtn" class="qr-camera-btn">
            <span class="camera-icon">📷</span>
        </button>
        <nav class="bottom-nav">
            <button class="nav-btn active" data-section="mapSection"><span class="nav-icon">🗺️</span><span class="nav-label">マップ</span></button>
            <button class="nav-btn" data-section="stampSection"><span class="nav-icon">🏆</span><span class="nav-label">スタンプカード</span></button>
            <button class="nav-btn" data-section="entrySection"><span class="nav-icon">🎁</span><span class="nav-label">応募</span></button>
        </nav>
        <div id="successModal" class="modal">
            <div class="modal-content">
                <div class="success-content">
                    <div class="success-icon">🎉</div>
                    <h3 id="successTitle">スタンプ獲得！</h3>
                    <p id="successMessage">おめでとうございます！</p>
                    <button id="closeSuccessModal" class="btn btn--primary">閉じる</button>
                </div>
            </div>
        </div>
        <div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="confirm-content">
            <h3 id="confirmTitle">応募の確認</h3>
            <p id="confirmMessage">A賞に応募しますか？</p>
            <div class="confirm-buttons">
                <button id="cancelApplyBtn" class="btn btn--secondary">いいえ</button>
                <button id="confirmApplyBtn" class="btn btn--primary">はい</button>
            </div>
        </div>
    </div>
</div>
    </div>

    <div id="loginPrompt" style="text-align: center; padding: 50px; display: none;">
        <h2>認証情報がありません</h2>
        <p>このアプリはポケットサインから起動してください。</p>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: flex;">
        <div class="spinner"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-client.js"></script>
    
    <script>
        // 認証処理を別スクリプトとして実装
        async function tryRefreshToken() {
            try {
                // LocalStorageから以前のユーザーIDを取得
                const savedUserId = localStorage.getItem('pocketsign_user_id');
                if (!savedUserId) return false;

                console.log('Trying to refresh token for user:', savedUserId);

                // refresh_tokenを使って新しいトークンを取得
                const { data, error } = await window.supabaseClient.functions.invoke('refresh-pocketsign-token', {
                    body: { userId: savedUserId }
                });

                if (error || !data.success) {
                    console.log('Refresh token failed:', error);
                    localStorage.removeItem('pocketsign_user_id');
                    return false;
                }

                // 新しいセッションを設定
                const { error: sessionError } = await window.supabaseClient.auth.setSession({
                    access_token: data.accessToken,
                    refresh_token: data.accessToken
                });

                if (sessionError) {
                    console.error('Session creation failed:', sessionError);
                    return false;
                }

                console.log('Successfully refreshed token');
                return true;
            } catch (error) {
                console.error('Error in tryRefreshToken:', error);
                return false;
            }
        }

        // 初期化時の認証チェック
        async function initializeAuth() {
            // ローディング画面を表示
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            const params = new URLSearchParams(window.location.search);
            
            if (params.get('dev') === 'true') {
                // 開発者モード
                console.log("🛠️ 開発者モードで起動しました。");
                const devUserId = '87177bcf-87a0-4ef4-b4c7-f54f3073fbe5';
                currentUser = { id: devUserId, email: 'developer@example.com' };
                document.getElementById('loadingOverlay').style.display = 'none';
                showAuthenticatedUI();
                loadAndInitializeApp();
                return;
            }

            try {
                // まずrefresh_tokenでの認証を試みる
                const refreshSuccess = await tryRefreshToken();
                
                if (refreshSuccess) {
                    // refresh_tokenでの認証成功 - 同意画面をスキップ
                    console.log('Authenticated via refresh token');
                    // この時点でonAuthStateChangeが発火するのを待つ
                } else {
                    // refresh_tokenがない or 失敗した場合は、通常の認証フローをチェック
                    const { data: { session } } = await window.supabaseClient.auth.getSession();
                    if (!session) {
                        // セッションがない場合のみログイン画面を表示
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('loginPrompt').style.display = 'block';
                        // 3秒後に認証ページへリダイレクト
                        setTimeout(() => {
                            window.location.href = './auth.html';
                        }, 3000);
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth initialization error:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('loginPrompt').style.display = 'block';
            }

            // Supabaseの認証状態変更を監視
            window.supabaseClient.auth.onAuthStateChange((event, session) => {
                if (session && (event === 'SIGNED_IN' || event === 'INITIAL_SESSION')) {
                    currentUser = session.user;
                    // ユーザーIDを保存（次回起動時のrefresh用）
                    localStorage.setItem('pocketsign_user_id', session.user.id);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    showAuthenticatedUI();
                    loadAndInitializeApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    localStorage.removeItem('pocketsign_user_id');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    showLoginUI();
                }
            });
        }

        // ページ読み込み時に認証を初期化
        document.addEventListener('DOMContentLoaded', initializeAuth);

        // visibilitychange イベントハンドラも追加
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentUser) {
                console.log("アプリが再度表示されました。位置情報を再チェックします。");
                checkInitialLocationAndSetCameraPermission();
            }
        });
    </script>
    
    <script src="app.js"></script>
</body>
</html>
